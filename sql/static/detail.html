{% extends "base.html" %}

{% block content %}
<div class="col-md-9 column">
	<h4>单子名称：<span id="editWorkflowNname">{{workflowDetail.workflow_name}}</span></h4>
	<hr>
		<table class="table table-striped table-hover" width='100%' style='table-layout:fixed;'>
			<thead>
				<tr>
					<th>
						ID
					</th>
					<th>
						实例
					</th>
					<th width="50%">
						SQL内容
					</th>
					<th>
						审核结果
					</th>
					<th>
						估算行数
					</th>
					<th>
						实际行数
					</th>
					<th>
						实际耗时(ms)
					</th>
					<th>
						执行状态
					</th>
				</tr>
			</thead>
			<tbody>
				{% for dictrow in listContent %}
				<tr>
					<td>
						{% if dictrow.stagestatus == "连接服务器异常" or dictrow.stagestatus == "sql执行异常" or dictrow.stagestatus == "解析失败" %}
							<font color="red">
						{% endif %}
						{{ dictrow.id }}
					</td>
				   <td>
						{% if dictrow.stagestatus == "连接服务器异常" or dictrow.stagestatus == "sql执行异常" or dictrow.stagestatus == "解析失败" %}
							<font color="red">
						{% endif %}
						{{ dictrow.clustername }}
					 </td>
				   <td class="td-need-pre" style="text-align: left" >{% if dictrow.stagestatus == "sql执行异常" or dictrow.stagestatus == "解析失败" %}<font color="red">{% endif %}{{ dictrow.sql }}
					 </td>
					 <td style='word-wrap:break-word;'>
						{% if dictrow.stagestatus == "连接服务器异常" or dictrow.stagestatus == "sql执行异常" or dictrow.stagestatus == "解析失败" %}
							<font color="red">
						{% endif %}
						{{ dictrow.errormessage }}
					</td>
					<td>
						{% if dictrow.stagestatus == "连接服务器异常" or dictrow.stagestatus == "sql执行异常" or dictrow.stagestatus == "解析失败" %}
							<font color="red">
						{% endif %}
						{{ dictrow.est_rows }}
					</td>
					<td>
						{% if dictrow.stagestatus == "连接服务器异常" or dictrow.stagestatus == "sql执行异常" or dictrow.stagestatus == "解析失败" %}
							<font color="red">
						{% endif %}
						{{ dictrow.real_rows }}
					</td>
					<td>
						{% if dictrow.stagestatus == "连接服务器异常" or  dictrow.stagestatus == "sql执行异常" or dictrow.stagestatus == "解析失败" %}
							<font color="red">
						{% endif %}
						{{ dictrow.execute_time }}
					</td>
					<td id="td_{{forloop.counter}}">
						{% if dictrow.stagestatus == "连接服务器异常" or dictrow.stagestatus == "sql执行异常" or dictrow.stagestatus == "解析失败" %}
							<font color="red">
						{% endif %}
						{% if workflowDetail.status == "执行中" %}
						<div>
							<div class="progress" style="width: 80%; height: 18px; float: left;">
								<div id="div_{{forloop.counter}}" class="progress-bar" role="progressbar" aria-valuenow="60"
									aria-valuemin="0" aria-valuemax="100" >
									<!--style="width: 100%;">-->
									<span id="span_{{forloop.counter}}"></span>
								</div>
							</div>
							<div style="width: 10%; height: 18px; float: right;">
								<form  method="post" >
									{% csrf_token %}
									<input type="hidden" name="workflowid" value="{{workflowDetail.id}}">
									<!--<input type="hidden" id="sqlID_{{row.0}}" value="{{row.0}}">-->
									<button id="btnstop_{{forloop.counter}}" value="{{forloop.counter}}" type="button" class="close" style="display: none" title="停止pt-OSC进程">
									 <span aria-hidden="true">&times;</span>
									 <span class="sr-only"></span>
									</button>
								</form>
							</div>
						</div>
						{% else %}
							{{ dictrow.stagestatus }}
						{% endif %}
					</td>
				</tr>
				{% endfor %}
				
			</tbody>
		</table>
		<div style="text-align:center;">
			<ul class="pagination" style="display:inline-block;">
					<!--{% if pages >= 5 %}i-->
				<li>
					<a href="?pageNo={{pageNo|add:"-1"}}">前一页</a>
				</li>
				{% for p in pageRange%}
				{% if p == pageNo %}
				<li class=active>
				{% else %}
				<li>
				{% endif %}
					<a href="?pageNo={{p}}">{{p|add:"+1"}}</a>
				</li>
				{% endfor %}
				<li>
					<a href="?pageNo={{pageNo|add:"1"}}">后一页</a>
				</li>
				<!--	 {% endif %}  -->

				 <!--
				{% if pages < 5 and pages > 1 %}
				 
				<li id="last_page">
					<a href="?pageNo={{pageNo|add:"-1"}}">前一页</a>
				</li>
				<li>
					<a href="?pageNo={{pageNo|add:"1"}}">后一页</a>
				</li>
				{% endif %} -->

			</ul>
		</div>
</div>
<div class="col-md-3 column">
	<input type="hidden" id="workflowDetail_id" name="workflowid" value="{{workflowDetail.id}}">
	<input type="hidden" id="editSqlContent" value="{{workflowDetail.sql_content}}"/>
	<input type="hidden" id="editClustername" value="{{workflowDetail.cluster_name}}"/>
	<input type="hidden" id="editIsbackup" value="{{workflowDetail.is_backup}}"/>
	<input type="hidden" id="editReviewman" value="{{listAllReviewMen.0}}"/>
	<input type="hidden" id="editSubReviewman" value="{{listAllReviewMen.1}}"/>
	<div>
			<table class="table table-striped table-hover" >
				<!-- <thead>
					<tr>
						<th>
							工单类型	
						</th>
						<th>
							上线发起人
						</th>
						<th>
							审核人
						</th>
						<th>
							上线实例
						</th>
					</tr>
				</thead> -->
				<tbody >
					<tr class="success">
						<th>
							工单类型	
						</th>
						<td>
							{{workflowDetail.data_change_type}}
						</td>
					</tr>
					<tr class="success">
						<th>
							上线发起人	
						</th>
						<td>
							{{workflowDetail.engineer}}
						</td>
					</tr>
					<tr class="success">
						<th>
							审核人	
						</th>
						<td>
							{{listAllReviewMen.0}} {{listAllReviewMen.1}}
						</td>
					</tr>
					<tr class="success">
						<th>
							上线实例	
						</th>
						<td>
							{{workflowDetail.cluster_name}}
							
						</td>
					</tr>
					
				</tbody>
			</table>
			<table class="table table-striped table-hover" >
				<!-- <thead>
					<tr>
						<th>
							发起时间
						</th>
						<th>
							结束时间
						</th>

					<!--	<th>
							是否备份
					</th> -->
						<!-- <th>
							当前状态
						</th>
						<th>
							原因
						</th>
					</tr> -->
				</thead>
				<tbody >
					<tr class="success">
						<th>
							发起时间
						</th>
						<td>
							{{workflowDetail.create_time|date:"Y-m-d H:i:s"}}
						</td>
					</tr>

					<tr class="success">
						<th>
							结束时间
						</th>
						<td>
							{{workflowDetail.finish_time|date:"Y-m-d H:i:s"}}
						</td>
					</tr>
					<tr class="success">
						<th>
								当前状态
						</th>
						<td>
							{% if workflowDetail.status == "已正常结束" %}
								<font color="green">
							{% else %}
								<font color="red">
							{% endif %}
								<B id="workflowDetail_status">{{workflowDetail.status}}</B></font>
						</td>
					</tr>
					<tr class="success">
						<th>
							原因
						</th>
						<td>
							{{workflowDetail.reason}}
						</td>
					</tr>
						<!--
						<td>
							{{workflowDetail.is_backup}}
						</td>-->
						<!-- <td>
							{% if workflowDetail.status == "已正常结束" %}
								<font color="green">
							{% else %}
								<font color="red">
							{% endif %}
								<B id="workflowDetail_status">{{workflowDetail.status}}</B></font>
						</td>
						<td>
							{{workflowDetail.reason}}
						</td>
					</tr> -->
					
				</tbody>
			</table>
			<div>
				<p>备注:</p>
				<textarea readonly=True style="height:180px;width:360px;resize: none;border: 0;margin-bottom: 10px;">{{workflowDetail.message}} </textarea>
			<div>
		</div>
		</div>
			
			<script>
				window.pages = '{{pages}}';
				window.pageNo = '{{pageNo}}';
			</script>
			<template id="sql_content_container">
				{{workflowDetail.sql_content}}
			</template>
			<input type="hidden" id="workflowid" value="{{workflowDetail.id}}">
				<input type="button" id="btnPerformed" data-toggle="modal" class="btn btn-default" data-target="#sql_list_view_modal" value="查看sql文本" />
				<input type="button" id="btnPerformed" data-toggle="modal" class="btn btn-default" data-target="#message_view_modal" value="查看备注" />
			{% if loginUser in listAllReviewMen %}
				{% if workflowDetail.status == '等待审核人审核' or workflowDetail.status == '自动审核不通过' %}
					<form action="/execute/"  method="post" style="display:inline-block;">
						{% csrf_token %}
						<input type="hidden" name="workflowid" value="{{workflowDetail.id}}">
						<input type="button" id="btnExecute" onclick="execute(event,this)" class="btn btn-primary btn-default" data-loading-text="Loading..." value="审核通过，自动执行" />
					</form>
					{% csrf_token %}
					<input type="button" id="btnPerformed" data-toggle="modal" class="btn btn-default" data-target="#sql_list_modal" value="手工执行" />
					<form action="/cancel/" method="post" style="display:inline-block;">
						{% csrf_token %}
						<input type="hidden" name="workflowid" value="{{workflowDetail.id}}">
						<input type="button" id="btnCancel" onclick="execute(event,this)" class="btn btn-default" data-loading-text="Loading..." value="终止流程" />
					</form>
				{% endif %}

				{% if workflowDetail.status == '已正常结束' and workflowDetail.is_backup == '是' %}
				<form action="/rollback/" method="get" style="display:inline-block;">
					{% csrf_token %}
					<input type="hidden" name="workflowid" value="{{workflowDetail.id}}">
					<input type="submit" id="btnRollback" class="btn btn-primary btn-default" data-loading-text="Loading..." value="查看回滚SQL" />
				</form>
				<form action="/cancel/" method="post" style="display:inline-block;">
					{% csrf_token %}
					<input type="hidden" name="workflowid" value="{{workflowDetail.id}}">
				</form>
				{% endif %}

				{% if workflowDetail.status == '等待手工执行' %}
					<input type="button" id="btnWait" data-toggle="modal" class="btn btn-default" data-target="#manual_confirm_dialog" value="手工确认" />
					<form action="/cancel/" method="post" style="display:inline-block;">
						{% csrf_token %}
						<input type="hidden" name="workflowid" value="{{workflowDetail.id}}">
					</form>
				{% endif %}

				{% if workflowDetail.status == '手工执行成功' or workflowDetail.status == '手工执行异常'%}
					<input type="button" data-toggle="modal" class="btn btn-default" data-target="#show_manual_log" value="手工操作日志" />
					<form action="/cancel/" method="post" style="display:inline-block;">
						{% csrf_token %}
						<input type="hidden" name="workflowid" value="{{workflowDetail.id}}">
					</form>
				{% endif %}
				
				<!--
				{% if workflowDetail.status == '执行有异常' %}
					<form action="/cancel/" method="post" style="display:inline-block;">
						{% csrf_token %}
						<input type="hidden" name="workflowid" value="{{workflowDetail.id}}">
						<input type="button" id="btnCancel" onclick="execute(event,this)" class="btn btn-default" data-loading-text="Loading..." value="终止流程" />
					</form>
				{% endif %}
				{% if workflowDetail.status == '人工终止流程' %}
					{% csrf_token %}
					<a type='button' id="btnEditSql" class='btn btn-warning' href="/editsql/?workflowid={{workflowDetail.id}}">重新修改</a>
				{% endif %}
				-->

			{% endif %}

			{% if loginUser == workflowDetail.engineer %}
				{% if workflowDetail.status == '自动审核不通过' %}
					<!--只允许发起人修改工单-->
					{% csrf_token %}
					<a type='button' id="btnEditSql" class='btn btn-warning' href="/editsql/?workflowid={{workflowDetail.id}}">重新修改</a>
					<form action="/cancel/" method="post" style="display:inline-block;">
						{% csrf_token %}
						<input type="hidden" name="workflowid" value="{{workflowDetail.id}}">
						<input type="button" id="btnCancel" onclick="execute(event,this)" class="btn btn-default" data-loading-text="Loading..." value="终止流程" />
					</form>
				{% endif %}
			{% endif %}
		</div>
			
			<div class="modal fade" tabindex="-1" role="dialog" id="show_manual_log" aria-labelledby="modalLabel">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-body">
							<div class="modal-sql-content">{{workflowDetail.execute_result}}</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
						</div>
					</div>
				</div>
			</div>
			<div class="modal fade" tabindex="-1" role="dialog" id="manual_confirm_dialog" aria-labelledby="modalLabel">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title" id="modalLabel">手工确认</h4>
					</div>
					<div class="modal-body">
						<div id="modal_manual_submit">
							<div class="form-group">
								<span>status:</span>
								<select id="manual_status_select" class="normal-select">
									<option value="1">success</option>
									<option value="0">fail</option>
								</select>
							</div>
							<div class="form-group">
								<p>log:</p>
								<textarea id="sql_content" class="log-textarea"></textarea>
							</div>
							<div class="form-group">
								<input id="btn-addAttachment" type="file" class="btn btn-add-attachment" value="add-attachment" />
								<!-- <input id="btn-readAttachment" type="button" class="btn btn-primary" value="提交" /> -->
							</div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
						<button type="button" class="btn btn-primary" id="confirm_manual_submit">提交</button>
					</div>
					</div>
				</div>
			</div>
			<div class="modal fade" tabindex="-1" role="dialog" id="sql_list_modal" aria-labelledby="myModalLabel">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title" id="myModalLabel">sql文本</h4>
					</div>
					<div class="modal-body">
						<div id="modal_sql_content" class="modal-sql-content">{{workflowDetail.sql_content}}</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
						<button type="button" class="btn btn-primary" id="confirm_manual">Confirm</button>
					</div>
					</div>
				</div>
			</div>
			<div class="modal fade" tabindex="-1" role="dialog" id="sql_list_view_modal" aria-labelledby="myModalLabelView">
					<div class="modal-dialog" role="document">
						<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
							<h4 class="modal-title" id="myModalLabelView">sql list view</h4>
						</div>
						<div class="modal-body">
							<div id="show_modal_sql_content" class="modal-sql-content">{{workflowDetail.sql_content}}</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
							<button type="button" class="btn btn-primary" id="download-btn">下载</button>
							<a onfocus="this.blur();" download="sql.txt" id="createInvote" class="hide" >code</a>
						</div>
						</div>
					</div>
				</div>
			<div class="modal fade" tabindex="-1" role="dialog" id="message_view_modal" aria-labelledby="myModalLabelView1">
					<div class="modal-dialog" role="document">
						<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
							<h4 class="modal-title" id="myModalLabelView1">备注</h4>
						</div>
						<div class="modal-body">
							<div id="show_modal_msg_content" class="modal-sql-content td-need-pre-line">{{workflowDetail.message}}</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
							<button type="button" class="btn btn-primary" id="download-msg-btn">DownLoad</button>
							<a onfocus="this.blur();" download="message.txt" id="createInvoteMsg" class="hide" >code</a>
						</div>
						</div>
					</div>
				</div>
{% endblock content%}
